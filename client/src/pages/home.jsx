import React, { useState, useEffect } from "react";
import { DocumentSidebar } from "@/components/DocumentSidebar.jsx";
import { ChatContainer } from "@/components/ChatContainer.jsx";
import { useTheme } from "@/components/ThemeProvider.jsx";
import { Button } from "@/components/ui/button";
import { useDocuments } from "@/hooks/useDocuments.js";
import LoadingOverlay from "@/components/LoadingOverlay.jsx";
import UserMenu from "@/components/UserMenu.jsx";

export default function Home() {
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const { theme, toggleTheme } = useTheme();
  const { data: documents } = useDocuments();
  const [selectedDocumentName, setSelectedDocumentName] = useState("");

  useEffect(() => {
    if (!documents || documents.length === 0) return;
    if (!selectedDocumentName) {
      setSelectedDocumentName(documents[0].filename);
    } else {
      const stillExists = documents.some(d => d.filename === selectedDocumentName);
      if (!stillExists) {
        setSelectedDocumentName(documents[0].filename);
      }
    }
  }, [documents]);

  return (
    <div className="min-h-screen bg-background">
      <LoadingOverlay />
      {/* Navigation Header */}
      <nav className="fixed top-0 left-0 right-0 z-50 bg-background/95 backdrop-blur-sm border-b border-border">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center space-x-3">
              <div className="w-8 h-8 ai-gradient rounded-lg flex items-center justify-center">
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
              </div>
              <h1 className="text-xl font-bold text-foreground">AI DocChat</h1>
            </div>
            <div className="flex items-center space-x-4">
              {/* Dark Mode Toggle */}
              <button
                onClick={toggleTheme}
                className="relative inline-flex h-6 w-11 items-center rounded-full bg-muted transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                data-testid="theme-toggle"
              >
                <span className="sr-only">Toggle dark mode</span>
                <span
                  className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform flex items-center justify-center ${
                    theme === "dark" ? "translate-x-6" : "translate-x-1"
                  }`}
                >
                  {theme === "dark" ? (
                    <svg className="w-3 h-3 text-slate-700" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                    </svg>
                  ) : (
                    <svg className="w-3 h-3 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" />
                    </svg>
                  )}
                </span>
              </button>
              <UserMenu />
            </div>
          </div>
        </div>
      </nav>

      {/* Main Container */}
      <div className="flex min-h-screen pt-16">
        {/* Desktop Sidebar */}
        <div className="hidden lg:block">
          <DocumentSidebar isOpen={true} onClose={() => {}} selectedDocumentName={selectedDocumentName} onSelectDocument={setSelectedDocumentName} />
        </div>

        {/* Mobile/Tablet Sidebar */}
        <DocumentSidebar isOpen={sidebarOpen} onClose={() => setSidebarOpen(false)} selectedDocumentName={selectedDocumentName} onSelectDocument={(name) => { setSelectedDocumentName(name); setSidebarOpen(false); }} />

        {/* Chat Container */}
        <ChatContainer selectedDocumentName={selectedDocumentName} />
      </div>

      {/* Mobile Sidebar Toggle - Vertical Column Layout */}
      <div className="fixed left-0 top-1/2 transform -translate-y-1/2 lg:hidden z-50 flex flex-col items-center space-y-4 bg-background/95 backdrop-blur-sm border-r border-border rounded-r-lg shadow-lg p-3 mobile-sidebar-toggle">
        <button
          className="btn-ai p-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-200"
          onClick={() => setSidebarOpen(true)}
          data-testid="mobile-sidebar-toggle"
          aria-label="Open document sidebar"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
        <div className="w-8 h-px bg-border"></div>
        <button
          className="p-3 rounded-lg bg-muted/50 hover:bg-muted transition-colors"
          onClick={toggleTheme}
          aria-label="Toggle theme"
        >
          {theme === "dark" ? (
            <svg className="w-4 h-4 text-muted-foreground" fill="currentColor" viewBox="0 0 24 24">
              <path d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
            </svg>
          ) : (
            <svg className="w-4 h-4 text-muted-foreground" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" />
            </svg>
          )}
        </button>
      </div>
    </div>
  );
}
